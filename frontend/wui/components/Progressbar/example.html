<!DOCTYPE html>
<html>
<head>
	<script type="text/javascript" src="../../../events/EventEmitter.js"></script>
	<script type="text/javascript" src="../../core/script.js"></script>
	<script type="text/javascript" src="../../core/Dom/script.js"></script>
	<script type="text/javascript" src="./script.js"></script>
	<link type="text/css" rel="stylesheet" href="./styles.css"></link>
</head>
<body>

<h1>Progressbar</h1>
<span>Value: </span><span id="value"></span>/571
<div class="myProgressbarContainer"></div>
<!-- update progress -->
<br /><span ontouchstart="loopUpdate();" ontouchend="stopLoopUpdate();" onmousedown="loopUpdate();" onmouseup="stopLoopUpdate();"  style="display: none; cursor: pointer; border: 1px solid #666; text-align: center; padding: 4px; margin: 4px;">Press and Hold to Update</span><input type="number" id="adj" /><button onclick="update();">Update</button>
<!-- change direction -->
<br /><br /><div id="dir">rightToLeft</div><button onclick="change();">Change Direction ("right to left" -> "left to right" -> "bottom to top" -> "top to bottom")</button>

<script type="text/javascript">
var container = document.querySelector('.myProgressbarContainer');
var loop = null;
var maxValue = 571;
var current = 571;
var value = document.getElementById('value');
var adj = document.getElementById('adj');
var pos = 1;
var order = ["rightToLeft", "leftToRight", "bottomToTop", "topToBottom"];
value.textContent = maxValue;
adj.value = maxValue;
// create progressbar
var pb = new window.wui.components.Progressbar(maxValue, { numberOfProgress: 2, borderRadius: [0, 0, 5, 5], horizontalWidth: 300, horizontalHeight: 15, verticalWidth: 10, verticalHeight: 100 });
var animation = new anim('bar', pb, 500);
pb.on('Progressbar.update', function (data) {
	value.textContent = data.currentValues[0].value;
	// animate each progress
	animation.set(pb.getBars()[0], data.previousValues[0].ratio, data.currentValues[0].ratio);
	animation.set(pb.getBars()[1], data.previousValues[1].ratio, data.currentValues[1].ratio);
});
container.appendChild(pb.rootElement);

function anim(prefix, progressObj, speed) {
	var dir = progressObj;
	var dur = speed;
	var timer = null;
	var def = '';
	var counter = 0;
	var key = '';
	var cls = '';
	var animating = false;
	var pending = [];
	var self = this;

	this.set = function (target, fromRatio, toRatio) {
		target.pause(); // pause the progress before animation
		if (animating) {
			pending.push({ target: target, from: fromRatio, to: toRatio });
			return;
		}
		var t = target;
		animating = true;
		key = prefix + 'key' + counter;
		cls = prefix + 'amin' + counter;
		def = '<style type="text/css">';
		def += '@-webkit-keyframes ' + key + ' {';
		if (dir.getOrientation() === 'horizontal') {
			def += '0% { -webkit-transform: scale(' + fromRatio + ', 1); }';
			def += ' 100% { -webkit-transform: scale(' + toRatio + ', 1); }';
		}
		else {
			def += '0% { -webkit-transform: scale(1, ' + fromRatio + '); }';
			def += ' 100% { -webkit-transform: scale(1, ' + toRatio + '); }';
		}
		def += '} .' + cls + ' { -webkit-animation: ' + key + ' ' + dur + 'ms linear 1 normal; }';
		def += '</style>';
		document.head.innerHTML += def;
		t.className += ' ' + cls;
		if (timer) {
			clearTimeout(timer);
			timer = null;
		}
		counter += 1;
		timer = setTimeout(function () {
			clearTimeout(timer);
			timer = null;
			document.head.innerHTML = document.head.innerHTML.replace(def, '');
			t.className = t.className.replace(' ' + cls, '');
			animating = false;
			key = '';
			cls = '';
			def = '';
			t.resume(); // resume the progress
			// check for pending animation
			var next = pending.shift();
			if (next) {
				self.set(next.target, next.from, next.to);
			}
		}, dur);
	};
}


function loopUpdate() {
	if (!loop) {
		loop = setTimeout(function () {
			current -= 10;
			if (current < 0) {
				current = maxValue;
			}
			var red = current * 1.1;
			pb.update(current, red)
			clearTimeout(loop);
			loop = null;
			adj.value = current;
			loopUpdate();
		}, 50);
	}
}

function stopLoopUpdate() {
	clearTimeout(loop);
	loop = null;
}

function update() {
	var val = Number(adj.value);
	current = val;
	var red = current * 1.1;
	pb.update(val, red);
}

function change() {
	var dir = order[pos];
	document.getElementById('dir').textContent = dir;
	pb[dir]();
	update();

	pos += 1;

	if (pos >= order.length) {
		pos = 0;
	}
}
</script>
</body>
</html>
